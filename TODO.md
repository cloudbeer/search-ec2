# 自然语言商品搜索系统开发任务清单

## 项目概述
基于 Golang + Gin + Qdrant 构建的自然语言商品检索系统，支持混合检索（向量检索 + 过滤器）和动态配置。

## 阶段1: 基础架构搭建 🏗️

### 1.1 项目初始化
- [x] 创建 Go 项目结构
- [x] 初始化 go.mod 和依赖管理
- [x] 设置项目目录结构
  ```
  search-ec2/
  ├── cmd/
  │   └── server/
  │       └── main.go
  ├── internal/
  │   ├── config/
  │   ├── handlers/
  │   ├── models/
  │   ├── services/
  │   └── utils/
  ├── config/
  │   ├── function_calling_schema.json
  │   ├── variant_prompt.txt
  │   └── app_config.yaml
  ├── docker/
  ├── docs/
  └── scripts/
  ```

### 1.2 依赖管理
- [x] 添加 Gin 框架依赖
- [x] 添加 Qdrant Go 客户端
- [x] 添加配置文件解析库 (viper)
- [x] 添加日志库 (logrus/zap)
- [ ] 添加 HTTP 客户端 (用于调用 OpenAI API)
- [ ] 添加 JSON Schema 验证库

### 1.3 配置系统
- [x] 设计配置文件结构 (app_config.yaml)
- [x] 实现配置文件加载和解析
- [x] 支持环境变量覆盖配置
- [x] 实现配置热加载机制
- [x] 创建默认配置文件模板

### 1.4 Gin 框架搭建
- [x] 设置 Gin 路由结构
- [x] 实现中间件 (CORS, 日志, 错误处理)
- [x] 设置统一的响应格式
- [x] 实现健康检查接口 `/api/health`

## 阶段2: 核心服务开发 🔧

### 2.1 数据模型设计
- [x] 定义商品数据结构 (Product struct)
- [x] 定义商品变体结构 (ProductVariant struct)
- [x] 定义搜索请求/响应结构
- [x] 定义 Function Calling 解析结果结构
- [x] 实现数据验证和序列化

### 2.2 Qdrant 连接服务
- [x] 实现 Qdrant 客户端连接
- [x] 封装基础 CRUD 操作 (简化版本)
- [x] 实现 Collection 管理 (创建/删除/检查)
- [x] 实现向量插入和批量插入 (简化版本)
- [x] 实现混合检索 (向量检索 + 过滤器) (简化版本)
- [x] 添加连接池和错误重试机制

### 2.3 向量化服务
- [x] 实现 OpenAI Embeddings API 调用
- [x] 支持多种向量化模型 (可配置切换)
- [x] 实现批量向量化处理
- [x] 添加向量化缓存机制
- [x] 实现向量化错误处理和重试

### 2.4 Function Calling 解析服务
- [x] 实现动态 Function Schema 加载
- [x] 实现 OpenAI Function Calling API 调用
- [x] 解析用户查询意图到结构化数据
- [x] 支持多种查询类型解析
- [x] 实现解析结果验证和错误处理

### 2.5 AI 变体生成服务
- [x] 实现变体生成提示词模板
- [x] 调用 LLM 生成商品变体描述
- [x] 支持变体数量动态控制
- [x] 实现变体质量过滤
- [x] 添加变体生成缓存

### 2.6 服务管理器
- [x] 创建服务管理器整合所有服务
- [x] 实现服务健康检查
- [x] 实现系统统计信息收集
- [x] 实现优雅关闭机制

## 阶段3: 检索系统实现 🔍

### 3.1 混合检索算法
- [ ] 实现查询意图解析流程
- [ ] 实现向量检索逻辑
- [ ] 实现过滤器构建和应用
- [ ] 实现结果合并和去重
- [ ] 优化检索性能

### 3.2 搜索接口开发
- [ ] 实现 `POST /api/search` 接口
- [ ] 支持自然语言查询输入
- [ ] 返回商品列表和相关度评分
- [ ] 实现搜索结果分页
- [ ] 添加搜索日志和统计

### 3.3 结果排序和评分
- [ ] 实现向量相似度评分
- [ ] 实现多维度评分融合
- [ ] 支持自定义排序规则
- [ ] 实现结果多样性控制
- [ ] 添加评分解释功能

### 3.4 搜索优化
- [ ] 实现搜索结果缓存
- [ ] 优化查询性能
- [ ] 实现搜索建议功能
- [ ] 添加搜索分析和监控
- [ ] 实现 A/B 测试支持

## 阶段4: 商品管理功能 📦

### 4.1 商品 CRUD 接口
- [ ] `POST /api/products` - 单个商品录入
- [ ] `GET /api/products/{id}` - 获取商品详情
- [ ] `PUT /api/products/{id}` - 商品更新
- [ ] `DELETE /api/products/{id}` - 商品删除
- [ ] 实现商品数据验证

### 4.2 批量导入功能
- [ ] `POST /api/products/batch` - 批量商品导入
- [ ] 支持 JSON/CSV 格式导入
- [ ] 实现导入进度跟踪
- [ ] 添加导入错误处理和报告
- [ ] 实现增量更新支持

### 4.3 变体管理
- [ ] `POST /api/products/{id}/variants/regenerate` - 重新生成变体
- [ ] 实现变体批量更新
- [ ] 支持手动变体编辑
- [ ] 实现变体版本管理
- [ ] 添加变体质量评估

### 4.4 数据同步和一致性
- [ ] 实现商品数据变更同步到向量库
- [ ] 添加数据一致性检查
- [ ] 实现数据备份和恢复
- [ ] 添加数据迁移工具

## 阶段5: 配置管理系统 ⚙️

### 5.1 Function Calling 配置管理
- [ ] `GET /api/config/function-schema` - 获取配置
- [ ] `PUT /api/config/function-schema` - 更新配置
- [ ] 实现配置验证和测试
- [ ] 支持配置版本管理
- [ ] 实现配置回滚功能

### 5.2 变体生成配置
- [ ] `GET /api/config/variant-prompt` - 获取提示词
- [ ] `PUT /api/config/variant-prompt` - 更新提示词
- [ ] 实现提示词模板管理
- [ ] 支持多语言提示词
- [ ] 添加提示词效果测试

### 5.3 系统配置管理
- [ ] 实现运行时配置更新
- [ ] 添加配置变更审计日志
- [ ] 实现配置导入导出
- [ ] 支持环境配置隔离

## 阶段6: 系统监控和统计 📊

### 6.1 系统监控
- [ ] `GET /api/health` - 健康检查
- [ ] `GET /api/stats` - 系统统计信息
- [ ] 实现性能指标收集
- [ ] 添加错误率监控
- [ ] 实现资源使用监控

### 6.2 业务统计
- [ ] 搜索量统计
- [ ] 热门查询分析
- [ ] 商品检索效果分析
- [ ] 用户行为分析
- [ ] 生成统计报告

## 阶段7: 部署和优化 🚀

### 7.1 Docker 容器化
- [ ] 编写 Dockerfile
- [ ] 创建 docker-compose.yml
- [ ] 配置多阶段构建
- [ ] 优化镜像大小
- [ ] 实现健康检查

### 7.2 性能优化
- [ ] 实现连接池优化
- [ ] 添加缓存层
- [ ] 优化内存使用
- [ ] 实现并发控制
- [ ] 性能压测和调优

### 7.3 错误处理和日志
- [ ] 实现统一错误处理
- [ ] 添加结构化日志
- [ ] 实现错误报警
- [ ] 添加调试工具
- [ ] 实现日志轮转

### 7.4 文档和测试
- [ ] 编写 API 文档 (Swagger)
- [ ] 添加单元测试
- [ ] 实现集成测试
- [ ] 编写部署文档
- [ ] 创建使用示例

## 配置文件模板

### Function Calling Schema 示例
```json
{
  "function_name": "parse_product_query",
  "description": "解析用户商品查询意图",
  "parameters": {
    "type": "object",
    "properties": {
      "product_type": {
        "type": "string",
        "description": "商品类型，如牛仔裤、T恤等"
      },
      "color": {
        "type": "string", 
        "description": "颜色要求"
      },
      "price_min": {
        "type": "number",
        "description": "最低价格"
      },
      "price_max": {
        "type": "number", 
        "description": "最高价格"
      },
      "brand": {
        "type": "string",
        "description": "品牌要求"
      },
      "size": {
        "type": "string",
        "description": "尺寸要求"
      }
    }
  }
}
```

### 变体生成提示词模板
```
根据以下商品信息，生成 {variant_count} 个不同的自然语言描述变体：

商品信息：
- 名称：{product_name}
- 分类：{category}
- 颜色：{color}
- 价格：{price}
- 品牌：{brand}
- 描述：{description}

要求：
1. 每个变体都要包含核心商品信息
2. 使用不同的表达方式和同义词
3. 包含口语化和正式化的表达
4. 变体之间要有明显差异
5. 保持信息准确性

请以 JSON 数组格式返回变体列表。
```

## 开发优先级
1. **P0 (必须)**: 阶段1-3 (基础架构 + 核心检索功能)
2. **P1 (重要)**: 阶段4-5 (商品管理 + 配置管理)
3. **P2 (优化)**: 阶段6-7 (监控统计 + 部署优化)

## 技术债务和注意事项
- [ ] 实现优雅关闭
- [ ] 添加限流和防护
- [ ] 实现数据加密
- [ ] 考虑多租户支持
- [ ] 添加 API 版本管理
- [ ] 实现分布式部署支持

---
**准备就绪后，从阶段1开始逐步实现！** 🚀
